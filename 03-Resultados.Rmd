# Resultados
## Datos Utilizados

```{r inputs}

# inputs / suposiciones

tipo_cambio <- 18.83 
# tomado de https://www.banxico.org.mx/tipcamb/main.do?page=tip&idioma=sp
# el 14 de marzo de 2023

# Opciones de formulacion
formulaciones <- c("E1", "E2") 
# faltan opciones para "E1-E1", "E1-E2", "E1-E1-E2"

# opciones de compuestos activos para formulacion "E1"
opciones_E1 <- c("Clorhidrato de fenilefrina", "Clorhidrato de difenhidramina")

# opciones de compuestos activos para formulacion E2
opciones_E2 <- c("Acetaminofén")

# cargar composicion de las formulaciones
composicion <- read_csv("datos/composicion.csv", show_col_types = FALSE)

# Definir parametros para simulacion de ordenes para costo promedio
sim_num <- 2000

# Definir variables para funciones de costos:

# Material
costo_frasco <- 10 #[MXN]

## Labor
t_fabricacion <- 40 #[min]
salario_trabajador <- 400 / (8 * 60) #[MXN/min]
eficiencia_trabajador <- 0.75 #[]

## Energia
t_impresion <- 20 #[min]
# 500[W]*3,600[J/Wh]*1/60[h/min]
consumo_energetico_impresora <- 500*3600/60 #[J/min]
eficiencia_calentador <- 0.6 #[]
costo_electricidad <- 0.976 / 3600000 #[MXN/J]
#https://www.cfe.mx/hogar/tarifas/Pages/Acuerdosdetarifasant.aspx#
#:~:text=Cargos%20por%20energ%C3%ADa%20consumida%3A,hora%20adicional%
#20a%20los%20anteriores.

## Distribucion
t_transporte <- 180 #[min]
distancia <- 20 #[km]
precio_gasolina <- 25 #[MXN/L]
eficiencia_vehiculo <- 35 #[km/L]
numero_tabletas_viaje <- 1000 #[tabletas]


input_inicial <- tibble(
  variable=c("Tipo de Cambio", "Costo Frasco", "Tiempo de fabricación", 
             "Salario Trabajador", "Eficiencia del Trabajador", 
             "Tiempo de impresión", "Consumo Energético Impresora", 
             "Eficiencia Calentador", "Costo Electricidad", 
             "Tiempo de Transporte", "Distancia por viaje", "Precio Gasolina",
             "Eficiencia del vehículo", "Tabletas por viaje"),
  valor=c(tipo_cambio, costo_frasco, t_fabricacion, 
          round(salario_trabajador*60, 2), eficiencia_trabajador*100, t_impresion,
          consumo_energetico_impresora/1000, eficiencia_calentador*100, 
          round(costo_electricidad*1000*1000*1000,2), t_transporte, distancia, 
          precio_gasolina, eficiencia_vehiculo, numero_tabletas_viaje),
  unidades=c("MXN/USD", "MXN", "min", "MXN/h", "%", "min", "KJ/min", "%", 
             "MXN/GJ", "min", "km", "MXN/L", "km/L", "tabletas")
)

input_inicial %>% 
  mutate(valor=currency(valor, "", digits=2)) %>% 
  kbl(col.names=c("Variable", "Valor", "Unidades"),
      align= c("lcl"),
      caption="Valores de entrada Tabletas Personalizables",
      label = "tabdatosentrada")

```
En la tabla \@ref(tab:tabdatosentrada) podemos observar los datos de entrada, y
sus unidades, que fueron utilizados en este trabajo que nos sirven para calcular 
los costos de energía, labor y distribución.

```{r infocompuestos}

# leer el archivo compounds, el cual tiene información del costo de los 
# compuestos, así como del calor de fusión y el calor específico (los cuales
# se encuentran en J/g y en J/gC, respectivamente)
info_compuestos <- read_csv("datos/compounds.csv", show_col_types = FALSE)

info_compuestos <- info_compuestos[1:5] %>%
  mutate(Precio_mxn_g=Price_kg_usd*tipo_cambio/1000) %>% 
  select(-(Price_kg_usd))

info_compuestos %>%
  mutate(Precio_mxn_g=currency(Precio_mxn_g,"$", digits=2)) %>% 
  mutate_at(c("Specific_Heat", "Fusion_Heat", "Density"), ~na_if(.,0)) %>% 
  kbl(booktabs=T, col.names =
        c("Compuestos", "Calor Específico (J/gC)", 
                    "Calor de Fusión (J/g)", 
                    "Densidad (g/cm^3)", "Precio (MXN/g)"), 
      caption = "Características y precio de los componentes", 
      align = "lcccc", label = "tabinfocompuestos") %>%
  kable_styling(latex_options = c("scale_down")) %>%
  column_spec(2:5, width="3cm")

```
La tabla \@ref(tab:tabinfocompuestos) muestra la información, relacionada a los 
compuestos, utilizada para los cálculos del costo de materiales y de energía
de esta sección. Es importante recalcar que en algunos casos el calor específico 
y/o el calor de fusión muestran un valor de *NA*, esto es ya que no participan 
en el cambio de fase (en el caso donde el calor de fusión es *NA*) o no son 
sometidos a cambio de temperatura (en el caso donde tanto el calor específico, 
como el calor de fusión son *NAs*).

\newpage
## Costo de tabletas unitario

El cálculo del costo unitario de la producción de tabletas depende de la 
formulación de la misma, del compuesto activo, de la dosis y de la composición,
entre otras cosas. Mostramos un ejemplo de cómo se calculan los diferentes 
componentes del costo unitario antes de mostrar los resultados completos:

```{r costounitdatos}
ejemplo_1 <- read_rds("datos/ejemplo_E1.rds")
ejemplo_1 %>% select(formulacion, compuesto_activo, dosis) %>%
  mutate(dosis = round(dosis, 3)) %>%
  kbl(col.names = c("Formulación", "Compuesto Activo", "Dosis [g]"), 
      caption = "Ejemplo Costo Unitario", 
      align = "clc", label = "tabcostounitdatos")
```
En la tabla \@ref(tab:tabcostounitdatos) podemos observar el inicio de la 
simulación de una órden (o preescripción). Empezamos por la formulación (ésta 
puede ser E1 o E2), dependiendo del tipo de formulación escogemos un valor 
aleatorio para el compuesto activo dentro de las opciones para dicha formulación.
A continuación, generamos un valor aleatorio para la dosis del compuesto activo 
correspondiente.

```{r cudimensiones}
ejemplo_1$dimensiones[[1]] %>%
  kbl(col.names = c("Variable", "Valor"), 
      caption = "Ejemplo Costo Unitario - Dimensiones", 
      align = "lc", label = "tabcudimensiones")
```
Cada preescripción debe de tener una geometría específica (o dimensiones) de 
acuerdo a la metodología definida en la sección 
*Cálculo de material necesario para moldes*. Las dimensiones utilizadas para 
este ejemplo se  observan en la tabla \@ref(tab:tabcudimensiones).

```{r cucomposicion}
ejemplo_1$composicion[[1]] %>%
  mutate(Composicion=percent(Composicion,0)) %>% 
  kbl(col.names = c("Compuesto", "Composición"), 
      caption = "Ejemplo Costo Unitario - Composición", 
      align = "lc", label = "tabcucomposicion")

```
Al igual, cada una de las preescripciones requiere la composición de la matriz 
más allá del compuesto activo. Ver tabla \@ref(tab:tabcucomposicion).

```{r cucompuestos}
ejemplo_1$materiales[[1]] %>% 
  select(Compound, masa, Componente) %>%
    mutate_at(3, ~str_replace_all(., c("ME"="Matriz Externa",
                                       "MI"="Matriz Interna",
                                       "CU"="Cubierta",
                                       "MO"="Molde"))) %>%
  mutate(masa=round(masa, 3)) %>%
  kbl(col.names = c("Compuesto", "Masa [g]", "Componente"), 
      caption = "Ejemplo Costo Unitario - Compuestos", 
      align = "lcc", label = "tabcompuestos")

```

Utilizando la formulación, la dosis de compuesto activo, las dimensiones y la 
composición podemos calcular la cantidad de compuestos necesarios para los 
diferentes componentes de la tableta. Ver la tabla \@ref(tab:tabcompuestos).

\newpage

### Muestra `r currency(sim_num, "", 0)` preescripciones

```{r ordenes}
ordenes <- ordenes_personalizadas(sim_num)

if (file.exists("datos/ordenestabletassim.rds")) {
  costo_ordenes_ej <- read_rds("datos/ordenestabletassim.rds")
} else {
  costo_ordenes_ej <- ordenes %>%
  mutate(tabletas=round(rnorm(sim_num, 30, 1),0)) %>%
  mutate(c_materiales=pmap(list(materiales, tabletas), 
                               .f=costo_materiales)) %>%
  unnest(c_materiales) %>%
  mutate(t_fabricacion=round(rnorm(sim_num, t_fabricacion, 1),0)) %>%
  mutate(c_labor=pmap(list(tabletas, t_fabricacion), 
                      .f=costo_labor)) %>%
  unnest(c_labor) %>%
  mutate(t_impresion=round(rnorm(sim_num,t_impresion,1), 0),
         costo_electricidad=rep(costo_electricidad,sim_num),
         consumo_energetico=rep(consumo_energetico_impresora, sim_num)) %>%
  mutate(c_energia=pmap(list(materiales, t_impresion, 
                              costo_electricidad, consumo_energetico, 
                              formulacion),
                        .f=costo_energia)) %>%
  unnest(c_energia) %>%
  mutate(t_transporte=rnorm(sim_num,t_transporte,1), 
         salario_trabajador=rep(salario_trabajador, sim_num), 
         distancia=rnorm(sim_num, distancia, 3), 
         precio_gasolina=rep(precio_gasolina, sim_num), 
         eficiencia_vehiculo=rep(eficiencia_vehiculo, sim_num),
         numero_tabletas_viaje=rep(numero_tabletas_viaje, sim_num)) %>%
  mutate(c_distribucion=pmap(list(t_transporte, salario_trabajador, 
                                  distancia, precio_gasolina, 
                                  eficiencia_vehiculo,
                                  numero_tabletas_viaje), 
                             .f=costo_distribucion)) %>%
  unnest(c_distribucion) %>%
  select(formulacion, compuesto_activo, tabletas, 
         c_materiales, c_energia, c_labor, c_distribucion) %>%
  mutate(c_total=(c_materiales+c_energia+c_labor+c_distribucion)*tabletas)
  
  write_rds(costo_ordenes_ej, "datos/ordenestabletassim.rds")
}

costo_ordenes_ej[1:5,] %>%
  select(-c_total) %>% 
  mutate_at(c(4,5,6,7), ~currency(., "$", 2)) %>%
  select(-tabletas) %>% 
  kbl(col.names = c("Formulación","Compuesto Activo", 
                    "Costo Material", "Costo Energético", 
                    "Costo Labor", "Costo Distribución"),
      align = "clcccc",
      caption = "Preescripciones Aleatorias", label ="tabordenesej1") %>%
  kable_styling(latex_options = c("scale_down")) %>% 
  column_spec(2:6, width="3cm")
```
Utilizando la cantidad de los compuestos necesarios para fabricar cada una de 
las tabletas podemos calcular el costo unitario de cada una de las 
preescripciones. En la tabla \@ref(tab:tabordenesej1) podemos observar los 
primeros 5 valores de las `r currency(sim_num, "", 0)` órdenes simuladas.

\newpage
**Costo Preescripción**
```{r ctotalpreescripcion}
costo_ordenes_ej[1:5,] %>%
  select("formulacion", "compuesto_activo", "c_total") %>% 
  mutate(c_total=currency(c_total,"$",digits=2)) %>% 
  kbl(col.names = c("Formulación","Compuesto Activo", "Costo Total"),
      align = "clr",
      caption = "Costo total por preescripcion", label ="tabctotalpreesc") 
# %>%
  # kable_styling(latex_options = c("scale_down")) %>% 
  # column_spec(1:3, width="3cm")
```

En la tabla \@ref(tab:tabctotalpreesc) podemos observar el resultado del 
producto entre las tabletas solicitadas en la preescripción y la suma de los 
costos unitarios calculados.

```{r costounitariotableta}
costo_promedio <- costo_ordenes_ej %>%
  summarise(costo_tableta=sum(c_total)/sum(tabletas))

costo_promedio <- round(costo_promedio[[1]], 2)

ord_print <- costo_ordenes_ej %>%
  group_by(formulacion, compuesto_activo) %>%
  summarise(costo_tableta=round(sum(c_total)/sum(tabletas), 2), 
            .groups="keep") %>% 
  as.data.frame() 

ord_print %>%
  mutate(costo_tableta=currency(costo_tableta, "$", digits=2)) %>% 
  kbl(col.names = c("Formulación","Compuesto Activo", 
                    "Costo Promedio"),
      align = "clr",
      caption = "Costo de Tableta Promedio por Formulación", 
      label = "tabcostopromedioformula") 
# %>% 
#   column_spec(1:3, width="3cm")
```
En la tabla \@ref(tab:tabcostopromedioformula) podemos observar un resumen del 
costo promedio por formulación y compuesto activo relacionado de las 
`r currency(sim_num, "", 0)` preescripciones simuladas.

\newpage

## Costo de inversión

```{r inversioninstrumentos}

instrumentos <- read_csv("datos/instrumentos.csv", show_col_types = FALSE)
instrumentos[1:3] %>% 
  mutate(Precio=currency(Precio, symbol = "$", digits = 0L)) %>%
  kbl(col.names = c("Instrumento","Cantidad", 
                    "Precio"),
      align = "lcr",
      caption = "Equipo de Producción de Tabletas", 
      label = "tabequipoproduccion")
```

En la tabla \@ref(tab:tabequipoproduccion) se describen los equipos e 
instrumentos, así como los precios y cantidades utilizadas para el cálculo del 
costo de inversión del caso base.

```{r inversiontotal}
inversion_total <- instrumentos %>%
  mutate(costo=Precio*Cantidad) %>%
  select(costo) %>%
  sum()

inversion <- c(inversion_total, rep(0,10))

inv_total_print <- currency(inversion_total, "$", 0)
```

La inversión total estimada para el caso base es de `r inv_total_print`.

\newpage

## Depreciación

```{r depbase}

periodo_recuperacion <- 5
depreciacion <- tibble(
  periodo=0:10,
  depr=c(0, MACRS(investment = inversion_total, 
                     recovery_period = periodo_recuperacion, n.period = 10))
)

depreciacion %>% 
  mutate(depr=currency(depr, "$", 0)) %>%
    kbl(col.names = c("Periodo","Depreciación"),
      align = "cr",
      caption = "Perfil de Depreciación MACRS a 5 años", 
      label = "tabperfildepreciacion")
```

Con base en la inversión estimada y el periodo de recuperación (MACRS a 
`r periodo_recuperacion` años). Podemos calcular los el perfil de depreciación 
mostrado en la tabla \@ref(tab:tabperfildepreciacion).

\newpage

## Resultados Caso base

```{r inputscasobase}
expectativa_anual <- 150000 #[tabletas/periodo]
markup <- 0.5
material_trabajo <- 10 # kg de cada compuesto
tasa_gravable <- 0.3
tasa_descuento <- 0.09

input_caso_base <- tibble(
  Variable=c("Expectativa de venta de tabletas", "Markup", 
             "Material de Trabajo", "Tasa Gravable", "Tasa de Descuento"),
  Valor=c(expectativa_anual, markup*100, material_trabajo, 
          tasa_gravable*100, tasa_descuento*100),
  Unidades=c("tabletas/año", "%", "kg/compuesto", "%", "%")
)

input_caso_base %>%
  mutate(Valor=currency(Valor, "", 0)) %>% 
  kbl(align = "lcc",
      caption = "Datos de entrada para caso base", 
      label = "tabdatentradacasobase")
```

En la tabla \@ref(tab:tabdatentradacasobase) podemos encontrar los datos de 
entrada faltantes para poder calcular el caso base, así como las unidades en 
las que se encuentran los valores.

```{r casobase}

costos_anuales <- c(0, rep(expectativa_anual*costo_promedio, 10))
ingresos_anuales <- costos_anuales * (1 + markup)


capital_trabajo_inicial <- info_compuestos %>%
  mutate(capital_trabajo=Precio_mxn_g*material_trabajo*1000) %>%
  select(capital_trabajo) %>% sum()

cambio_CTN <- c(capital_trabajo_inicial, rep(0,10))

caso_base <- tibble(periodo=0:10,
      ingresos=ingresos_anuales, 
      costos=costos_anuales, 
      inversion=inversion, 
      depreciacion=depreciacion$depr, 
      cambio_CTN=cambio_CTN) 

caso_base%>%
  mutate(across(-1, ~currency(.x, symbol="$", digits=0))) %>%
  kbl(col.names = c("Periodo","Ingresos",
                    "Costos", "Inversión", 
                    "Depreciación", "Cambio de CTN"),
      align = "crrrrr",
      caption = "Flujos de Efectivo Caso Base", 
      label = "tabflujoscasobase")

```

En la tabla \@ref(tab:tabflujoscasobase) podemos observar todos los flujos de
efectivo necesarios para calcular los Flujos de Caja Libre del caso base.

```{r fcfcasobase}

fcf_caso_base <- caso_base %>%
  mutate(fcf=fcf(revenues=ingresos, 
                costs=costos, 
                depreciation=depreciacion, 
                capital_expenditures=inversion, 
                change_net_working_capital=cambio_CTN,
                tax_rate=tasa_gravable)) %>%
  unnest(fcf) %>%
  select(periodo, fcf)

fcf_caso_base %>%
  mutate(fcf=currency(fcf, "$", 0)) %>%
  kbl(col.names = c("Periodo","Flujo Libre"),
      align = "cr",
      caption = "Flujos de Efectivo Libre - Caso Base", 
      label = "tabflujolibrecasobase")
```

En la tabla \@ref(tab:tabflujolibrecasobase) observamos el Flujo de Caja Libre 
para cada uno de los periodos de evaluación del proyecto. Podemos notar el 
efecto que tiene la depreciación en aumentar el Flujo de Caja Libre sobre los 
periodos 1 a 6.

```{r npvcasobase}
npv_caso_base <- npv(rate=tasa_descuento, cashflow=fcf_caso_base$fcf, 
                     period=fcf_caso_base$periodo)
npv_caso_base_imp <- currency(npv_caso_base, "$", 0)
```

Sumando el producto de los flujos de caja libre por el ajuste por la tasa de 
descuento, obtenemos un Valor Presente Neto de `r npv_caso_base_imp` para el 
caso base.

\newpage

## Valor Monetario Esperado

Para esta parte suponemos que no podemos realizar este proceso de producción 
indefinidamente desde la cochera de nuestros padres, por lo cual tenemos que
preguntar si vale más la pena rentar o comprar un almacén. Al igual, tenemos que 
considerar que los equipos que utilizamos necesitan mantenimiento para seguir 
operando adecuadamente.

```{r vmedatosentrada}
precio_compra <- 1000000 # [MXN]
renta_anual <- 120000 # [MXN]
# tasa_descuento se mantiene
# inversion_total se mantiene

escenarios_costo <- round(costo_promedio * c(0.85, 1, 1.5), 2)
escenarios_tabletas <- expectativa_anual * c(0.7, 1, 1.2)
escenarios_markup <- markup * c(0.80, 1, 1.5)
escenarios_mantenimiento <- inversion_total * c(0.04, 0.05, 0.10)

escenarios <- c("B", "M", "A")
probabilidad <- c(0.15, 0.7, 0.15)

compra_flujo <- c(precio_compra, rep(0, 10))
renta_flujo <- c(0, rep(renta_anual,10))
inversion_flujo <- c(inversion_total, rep(0,10))

input_emv <- tibble(
  escenario=factor(c("Bajo", "Medio", "Alto")),
  costo=escenarios_costo, 
  tabletas=escenarios_tabletas,
  markup=escenarios_markup, 
  mant=escenarios_mantenimiento,
  prob=probabilidad
)

input_emv %>%
  mutate_at(2, ~currency(., "$", 2)) %>% 
  mutate_at(5, ~currency(., "$", 0)) %>% 
  mutate_at(3, ~currency(., "", 0)) %>% 
  mutate_at(c(4,6), ~percent(., 0)) %>% 
  kbl(col.names=c("Escenario", "Costo Promedio", "Expectativa Ventas", 
                  "Markup","Mantenimiento Anual", "Probabilidad"),
      align = "crrcrc",
      caption = "Datos de entrada para Valor Monetario Esperado", 
      label = "tabdatentradaemv") %>% 
  kable_styling(latex_options = c("scale_down"))
```


En la tabla \@ref(tab:tabdatentradaemv) se muestran los datos de entrada 
relevantes para calcular el Valor Presente Neto de los nodos terminales del 
árbol de decisión.

```{r populararbol}

opciones_comprar <- c("CO", "RE")
comprar <- Node$new("¿Comprar?", type="decision")

depreciacion_anual_emv <- c(0, MACRS(investment = inversion_total,
                                               recovery_period = 5,
                                               n.period=10))

# Agregar compra / renta
for (a in 1:2) {
  comprarenta <- comprar$AddChild(opciones_comprar[a], type="chance")
  
  # Agregar costo
  for (i in 1:3) {
  
    costo <- comprarenta$AddChild(paste("C",escenarios[i], sep=""), 
                                  type="chance")
    costo$prob <- probabilidad[i]
  
    # Agregar tabletas
    for (j in 1:3) {
      
      tabletas <- costo$AddChild(paste("T",escenarios[j], sep=""), 
                                 type="chance")
      tabletas$prob <- probabilidad[j]
      
      costo_anual_emv_j <- c(0, rep(escenarios_costo[i]*escenarios_tabletas[j],
                                   10))
      # Agregar Markup
      for (k in 1:3) {
        markup_es <- tabletas$AddChild(paste("U",escenarios[k],sep=""), 
                                       type="chance")
        
        markup_es$prob <- probabilidad[k]
        
        ingr_anual_emv <- costo_anual_emv_j*(1 + escenarios_markup[k])
        
        # Agregar Mantenimiento
        for (l in 1:3) {
          mantenimiento <- markup_es$AddChild(
            paste("M",escenarios[l],sep=""),
            type="terminal")
          
          mantenimiento$prob <- probabilidad[l]
          
          mant_anual_emv <- c(0, rep(escenarios_mantenimiento[l], 10))
          
          costo_anual_emv_k <- costo_anual_emv_j + mant_anual_emv
          
          if (a == 1) {
            inversion_anual_emv <- inversion_flujo + compra_flujo
            cambio_CTN_emv_k <- cambio_CTN - c(rep(0,10), precio_compra)
            
          } else {
            inversion_anual_emv <- inversion_flujo
            costo_anual_emv_k <- costo_anual_emv_k + renta_flujo
          }
          
          
          fcl <- fcf(revenues=ingr_anual_emv,
                     costs=costo_anual_emv_k,
                     depreciation=depreciacion_anual_emv,
                     capital_expenditures=inversion_anual_emv,
                     change_net_working_capital=cambio_CTN_emv_k,
                     tax_rate=tasa_gravable)
          
          mantenimiento$npv <- npv(tasa_descuento, fcl, 0:11)
        }
      }
      
    }
  }
}

```


```{r arboldecision, fig.cap="Medio Árbol de Decisión Tabletas Personalizables", fig.align='center', out.width="90%"}

SetGraphStyle(comprar, rankdir = "TB")
SetNodeStyle(comprar, style = "filled,rounded", 
             label = AdjustNodeName, shape = "box")

plot(comprar$RE)
```
Ya que contamos con dos nodos de decisión, y cuatro variables más con tres 
escenarios cada una (es decir, $2 \times 3^4$), tenemos 162 nodos terminales.
En la figura \@ref(fig:arboldecision) podemos observar 81 nodos. Aquellos 
relacionados a la decisión de rentar un almacén central en lugar de comprarlo. 

```{r ejemplotabletasmedio, fig.cap="Árbol de Decisión a partir de un nodo de tabletas"}
t <- comprar$CO$CM$TM

plot(t)
```

En la figura \@ref(fig:ejemplotabletasmedio) podemos observar el árbol de 
decisión a partir del nodo de probabilidad del escenario medio para el volumen 
de tabletas. La nomenclatura del árbol de decisión es la siguiente:


**Variables**

- RE - Rentar
- CO - Comprar
- C - Costo Promedio de Producción
- T - Volumen de Tabletas
- U - Margen
- M - Mantenimiento

**Escenarios**

- A - Alto
- M - Medio
- B - Bajo


### Resultado del árbol de decisión

```{r calculoarboldecision}
comprar$Do(function(node) node$npv <- w_npv(node), 
           filterFun = isNotLeaf, traversal = "post-order")

comprar_df <- ToDataFrameTypeCol(comprar, "prob", "npv") %>% 
  as_tibble()

comprar_df$npv <- currency(comprar_df$npv, symbol = "$", digits = 0L)
comprar_df$prob <- percent(comprar_df$prob, digits = 0)

comprar_print <- comprar_df %>% 
  select(c(2:6,8)) %>% 
  mutate_at(c(2:5), ~str_replace_all(., c("[CTUM]{1}A{1}"="Alto",
                                              "[CTUM]{1}M{1}"="Medio",
                                              "[CTUM]{1}B{1}"="Bajo"))) %>%
  mutate_at(1, ~str_replace_all(.,c("RE"="Rentar",
                                    "CO"="Comprar")))
```


```{r graficacompravsrenta}
comprar_dftree <- ToDataFrameTree(comprar, "npv")

comprar_dftree %>% 
  mutate(npv=currency(npv,"$",digits=0)) %>% 
  filter(grepl("CO|RE", levelName)) %>% 
  mutate_at(1, ~str_replace_all(.,c("°--RE"="Rentar",
                                    "¦--CO"="Comprar"))) %>% 
    kbl(booktabs=T, 
      col.names = c("Decisión","EMV"),
      align = "lr",
      caption = "VME - Comprar vs Rentar", 
      label = "tabemvcomprarrentar")
```

La tabla \@ref(tab:tabemvcomprarrentar) señala la opción con el mayor Valor 
Monetario Esperado de las opciones.


### 10 Nodos Terminales con el mayor Valor Presente Neto

```{r emvtop10}

top10 <- comprar_print %>% 
  filter(npv >= 0) %>%
  arrange(desc(npv)) %>%
  head(10)
  
top10 %>% 
  kbl(longtable=T, booktabs=T, 
      col.names = c("Decisión", "Costo", "Volumen", "Margen", 
                    "Mantenimiento", "EMV"),
      align = "lllllr",
      caption = "VME Positivo (Top 10) - Tabletas Personalizables", 
      label = "tabemvtabletasarbol") %>% 
  kable_styling(latex_options = c("repeat_header")) %>% 
  column_spec(1:6, width="2cm")

```

### 10 Nodos Terminales con el menor Valor Presente Neto

```{r emvbottom10}

comprar_print %>% 
  arrange(npv) %>%
  head(10) %>% 
  arrange(desc(npv)) %>% 
  kbl(longtable=T, booktabs=T, 
      col.names = c("Decisión", "Costo", "Volumen", "Margen", 
                    "Mantenimiento", "EMV"),
      align = "lllllr",
      caption = "VME Positivo (Últimos 10) - Tabletas Personalizables", 
      label = "tabemvtabletasarbolbot") %>% 
  kable_styling(latex_options = c("repeat_header")) %>% 
  column_spec(1:6, width="2cm")

```

### Representación visual del VPN de los nodos terminales
```{r npvfacet, fig.cap="VPN Representación Visual"}

comprar_df %>%
  mutate(npv=npv) %>% 
  ggplot(mapping = aes(y=npv, x=level_3, color=level_2, shape = level_5)) +
  geom_point() +
  facet_grid(level_4 ~ level_6) +
  theme_bw() +
  scale_y_continuous(
    labels = label_dollar(scale_cut = cut_short_scale())
  ) +
  ylab("Valor Presente Neto") +
  xlab("Escenario de Costo de Producción") +
  labs(color = "Decisión", 
       shape = "Margen",
       caption = "Escenarios: A=Alto, M=Medio, B=Bajo
       Variables: M=Mantenimiento, T=Volumen Tabletas")
  
```

```{r graficaemv, fig.cap="Histograma del VPN de nodos terminales", message=FALSE}
opcion_emv <- comprar_print %>% 
  group_by(level_2) %>% 
  summarise(emv_mean = mean(npv),
            emv_median = median(npv),
            emv_05 = quantile(npv, 0.05),
            emv_95 = quantile(npv, 0.95))

comprar_print %>%
  mutate(npv=npv) %>% 
  ggplot() +
  geom_histogram(aes(npv)) +
  facet_wrap(~level_2) +
  geom_vline(data = opcion_emv, aes(xintercept = emv_mean, color="Promedio"),
             linetype=1, linewidth=0.5) +
    geom_vline(data = opcion_emv, aes(xintercept = emv_median, color="Media"),
             linetype=2, linewidth=0.5) +
    geom_vline(data = opcion_emv, aes(xintercept = emv_95, color="Quintil95"),
             linetype=3, linewidth=0.5) +
    geom_vline(data = opcion_emv, aes(xintercept = emv_05, color="Quintil05"),
             linetype=4, linewidth=0.5) +
  scale_color_manual(name = "Estadística", 
                     values=c(Promedio="blue",
                              Media="gray",
                              Quintil95="green",
                              Quintil05="red")) +
  ylab("Cuenta") +
  xlab("Valor Monetario Esperado (millones)") +
  theme_bw() + 
  coord_flip() +
  scale_x_continuous(
    labels = label_dollar(scale_cut = cut_short_scale())
  )
```


```{r graficaemvboxplot, fig.cap="Distribución de VPN por cada escenario de costo"}

comprar_print %>%
  mutate(npv=npv) %>% 
  ggplot(aes(level_3, npv)) +
  geom_boxplot() +
  facet_wrap(~level_2) +
  ylab("Valor Presente Neto") +
  xlab("Costo Promedio de Producción") +
  theme_bw() +
  scale_y_continuous(
    labels = label_dollar(scale_cut = cut_short_scale())
  )

```


\newpage
## Análisis de Sensibilidad

```{r sensdatosentrada}

rango_sens <- c(1, 0.7, 1.3)

tab_sens <- expectativa_anual * rango_sens
mup_sens <- markup * rango_sens
costo_sens <- costo_promedio * rango_sens
ren_sens <- renta_anual * rango_sens
desc_sens <- tasa_descuento * rango_sens
inv_sens <- inversion_total * rango_sens

input_sens <- tibble(
  escenario=factor(c("Base", "Bajo", "Alto")),
  inversion=inv_sens,
  tabletas=tab_sens,
  markup=mup_sens,
  costo=costo_sens,
  renta=ren_sens,
  descuento=desc_sens
)

col_sens <- c("Escenario", "Inversión", "Expectativa Venta", "Markup", 
              "Costo Promedio", "Renta", "Tasa de descuento")

input_sens %>%
  mutate_at(3, ~currency(., "",0)) %>% 
  mutate_at(c(4,7), ~percent(.,1)) %>%
  mutate_at(5, ~currency(., "$", 2)) %>% 
  mutate_at(c(2,6), ~currency(., "$", 0)) %>% 
  kbl(col.names = col_sens,
      align = "crrcrrc",
      caption = "Datos de Entrada para Análisis de Sensibilidad",
      label = "tabentradasens") %>% 
  kable_styling(latex_options = c("scale_down"))

```

En la tabla \@ref(tab:tabentradasens) podemos observar los valores de entrada 
para el análisi de sensibilidad.

```{r calculosensibilidad, fig.cap="Gráfica de Análisis de Sensibilidad"}

# Preparar la tabla para graficar los resultados
sens_setup <- tibble(
variable=rep(col_sens[-1],2),
escenario=c(rep("Bajo", length(col_sens)-1), rep("Alto", length(col_sens)-1))
)

# Preparar la lista para recibir los resultados de VPN
sens_npv_inter <- list(rep(0,length(col_sens)*2-2))

# Iterar sobre los casos
for (i in seq_along(sens_setup$variable)) {
  
  sens_npv_inter[i] <- calcular_npv_sens(sens_setup$variable[i], 
                                         sens_setup$escenario[i], 
                                         length(col_sens))
}

# Calcular caso base
sens_base <- calcular_npv_sens("No aplica", "Alto", length(sens_setup$variable))
sens_base <- unlist(sens_base)

sens_npv_inter <- unlist(sens_npv_inter)

sens_results <- sens_setup %>% 
  mutate(npv=sens_npv_inter,
         diff=percent((npv-sens_base)/sens_base, 2))

n <- (length(sens_results$variable)/2)

sensitivity(variables = sens_results$variable[1:n], 
            low = sens_results$diff[1:n],
            high = sens_results$diff[(n+1):(n*2)]) %>% 
  tornado() +
  labs(
    title = "Gráfica de Tornado de Tabletas Personalizables",
    fill = "",
    x = "Cambio respecto a VPN Caso Base",
    y = "Variable"
  )

```

La figura \@ref(fig:calculosensibilidad) muestra el impacto que tiene sobre el 
Valor Presente Neto del caso base un cambio del $\pm30\%$ sobre el valor del 
escenario base. En ésta podemos observar que las variables con mayor 
influencia sobre el éxito de proyecto son: "Costo Promedio", "Margen" y 
"Expectativa de Venta" o "Volumen de Tabletas". Estas variables muestran un 
cambio igual sobre el Valor Presente Neto del caso base. 

Aunque en un principio llame la atención que el "Costo Promedio" tenga un 
impacto positivo sobre la viabilidad del proyecto, esto está dado por nuestra 
definición de la ecuación de ingresos (ver ecuación \@ref(eq:ingresos)). 
Examinando la ecuación \@ref(eq:fcfmod) vemos que el flujo libre de efectivo 
depende producto del Margen y del Costo Directo (el cual está dado por 
la ecuación \@ref(eq:costodirecto) y que depende directamente del producto del 
costo unitario y del número de tabletas).

Al igual podemos observar que la renta tiene un mayor impacto sobre el VPN que 
la inversión inicial a pesar de tener un valor absoluto menor en los tres 
escenarios. Esto está dado por el efecto que tiene la depreciación sobre el 
porción gravable.

\newpage
## Simulación Monte Carlo




\newpage
## Matriz de Decisiones


