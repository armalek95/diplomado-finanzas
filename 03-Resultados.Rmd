# Resultados
## Datos Utilizados

```{r inputs}

# inputs / suposiciones

tipo_cambio <- 18.83 
# tomado de https://www.banxico.org.mx/tipcamb/main.do?page=tip&idioma=sp
# el 14 de marzo de 2023

# Opciones de formulacion
formulaciones <- c("E1", "E2") 
# faltan opciones para "E1-E1", "E1-E2", "E1-E1-E2"

# opciones de compuestos activos para formulacion "E1"
opciones_E1 <- c("Clorhidrato de fenilefrina", "Clorhidrato de difenhidramina")

# opciones de compuestos activos para formulacion E2
opciones_E2 <- c("Acetaminofén")

# cargar composicion de las formulaciones
composicion <- read_csv("datos/composicion.csv", show_col_types = FALSE)

# Definir parametros para simulacion
sim_num <- 100

# Definir variables para funciones de costos:

# Material
costo_frasco <- 10 #[MXN]

## Labor
t_fabricacion <- 40 #[min]
salario_trabajador <- 400 / (8 * 60) #[MXN/min]
eficiencia_trabajador <- 0.75 #[]

## Energia
t_impresion <- 20 #[min]
consumo_energetico_impresora <- 100#[J/min]
eficiencia_calentador <- 0.6 #[]
costo_electricidad <- 0.976 / 3600000 #[MXN/J]
#https://www.cfe.mx/hogar/tarifas/Pages/Acuerdosdetarifasant.aspx#
#:~:text=Cargos%20por%20energ%C3%ADa%20consumida%3A,hora%20adicional%
#20a%20los%20anteriores.

## Distribucion
t_transporte <- 180 #[min]
distancia <- 20 #[km]
precio_gasolina <- 25 #[MXN/L]
eficiencia_vehiculo <- 35 #[km/L]
numero_tabletas_viaje <- 1000 #[tabletas]

```

```{r infocompuestos}

# leer el archivo compounds, el cual tiene información del costo de los 
# compuestos, así como del calor de fusión y el calor específico (los cuales
# se encuentran en J/g y en J/gC, respectivamente)
info_compuestos <- read_csv("datos/compounds.csv", show_col_types = FALSE)

info_compuestos <- info_compuestos[1:5] %>%
  mutate(Precio_mxn_g=Price_kg_usd*tipo_cambio/1000) %>% 
  select(-(Price_kg_usd))

info_compuestos %>%
  mutate(Precio_mxn_g=currency(Precio_mxn_g,"$", digits=2)) %>% 
  mutate_at(c("Specific_Heat", "Fusion_Heat", "Density"), ~na_if(.,0)) %>% 
  kbl(booktabs=T, col.names =
        c("Compuestos", "Calor Específico (J/gC)", 
                    "Calor de Fusión (J/g)", 
                    "Densidad (g/cm^3)", "Precio (MXN/g)"), 
      caption = "Características y precio de los componentes", 
      align = "lcccc", label = "tabinfocompuestos") %>%
  kable_styling(latex_options = c("scale_down")) %>%
  column_spec(2:5, width="3cm")

```
La tabla \@ref(tab:tabinfocompuestos) muestra la información, relacionada a los 
compuestos, utilizada para los cálculos de esta sección. Es importante recalcar 
que en algunos casos el calor específico y/o el calor de fusión muestran un 
valor de *NA*, esto es ya que no participan en el cambio de fase (en el caso 
donde el calor de fusión es *NA*) o no son sometidos a cambio de temperatura 
(en el caso donde tanto el calor específico, como el calor de fusión son *NAs*).

## Costo de tabletas unitario

El cálculo del costo unitario de la producción de tabletas depende de la 
formulación de la misma, del compuesto activo, de la dosis y de la composición,
entre otras cosas. Mostramos un ejemplo de cómo se calculan los diferentes 
componentes del costo unitario antes de mostrar los resultados completos:

```{r costounitdatos}
ejemplo_1 <- read_rds("datos/ejemplo_E1.rds")
ejemplo_1 %>% select(formulacion, compuesto_activo, dosis) %>%
  mutate(dosis = round(dosis, 3)) %>%
  kbl(col.names = c("Formulación", "Compuesto Activo", "Dosis [g]"), 
      caption = "Ejemplo Costo Unitario", 
      align = "clc", label = "tabcostounitdatos")
```

```{r cudimensiones}
ejemplo_1$dimensiones[[1]] %>%
  kbl(col.names = c("Variable", "Valor"), 
      caption = "Ejemplo Costo Unitario - Dimensiones", 
      align = "lc", label = "tabcudimensiones")
```

```{r cucomposicion}
ejemplo_1$composicion[[1]] %>%
  mutate(Composicion=percent(Composicion,0)) %>% 
  kbl(col.names = c("Compuesto", "Composición"), 
      caption = "Ejemplo Costo Unitario - Composición", 
      align = "lc", label = "tabcucomposicion")

```

```{r cucompuestos}
ejemplo_1$materiales[[1]] %>% 
  select(Compound, masa, Componente) %>%
  mutate(masa=round(masa, 3)) %>%
  kbl(col.names = c("Compuesto", "Masa [g]", "Componente"), 
      caption = "Ejemplo Costo Unitario - Compuestos", 
      align = "lcc", label = "tabcompuestos")

```

\newpage

### Muestra `r sim_num` preescripciones

```{r ordenes}
ordenes <- ordenes_personalizadas(sim_num)

if (file.exists("datos/ordenestabletassim.rds")) {
  costo_ordenes_ej <- read_rds("datos/ordenestabletassim.rds")
} else {
  costo_ordenes_ej <- ordenes %>%
  mutate(tabletas=round(rnorm(sim_num, 30, 1),0)) %>%
  mutate(c_materiales=pmap(list(materiales, tabletas), 
                               .f=costo_materiales)) %>%
  unnest(c_materiales) %>%
  mutate(t_fabricacion=round(rnorm(sim_num, t_fabricacion, 1),0)) %>%
  mutate(c_labor=pmap(list(tabletas, t_fabricacion), 
                      .f=costo_labor)) %>%
  unnest(c_labor) %>%
  mutate(t_impresion=round(rnorm(sim_num,t_impresion,1), 0),
         costo_electricidad=rep(costo_electricidad,sim_num),
         consumo_energetico=rep(consumo_energetico_impresora, sim_num)) %>%
  mutate(c_energia=pmap(list(materiales, t_impresion, 
                              costo_electricidad, consumo_energetico, 
                              formulacion),
                        .f=costo_energia)) %>%
  unnest(c_energia) %>%
  mutate(t_transporte=rnorm(sim_num,t_transporte,1), 
         salario_trabajador=rep(salario_trabajador, sim_num), 
         distancia=rnorm(sim_num, distancia, 3), 
         precio_gasolina=rep(precio_gasolina, sim_num), 
         eficiencia_vehiculo=rep(eficiencia_vehiculo, sim_num),
         numero_tabletas_viaje=rep(numero_tabletas_viaje, sim_num)) %>%
  mutate(c_distribucion=pmap(list(t_transporte, salario_trabajador, 
                                  distancia, precio_gasolina, 
                                  eficiencia_vehiculo,
                                  numero_tabletas_viaje), 
                             .f=costo_distribucion)) %>%
  unnest(c_distribucion) %>%
  select(formulacion, compuesto_activo, tabletas, 
         c_materiales, c_energia, c_labor, c_distribucion) %>%
  mutate(c_total=(c_materiales+c_energia+c_labor+c_distribucion)*tabletas) %>%
  mutate(across(c(4:8), ~round(.x, digits = 2)))
  
  write_rds(costo_ordenes_ej, "datos/ordenestabletassim.rds")
}

costo_ordenes_ej[1:5,] %>%
  select(-c_total) %>% 
  kbl(col.names = c("Formulación","Compuesto Activo", "Tabletas", 
                    "Costo Material", "Costo Energético", 
                    "Costo Labor", "Costo Distribución"),
      align = "clccccc",
      caption = "Preescripciones Aleatorias", label ="tabordenesej1") %>%
  kable_styling(latex_options = c("scale_down")) %>% 
  column_spec(2:7, width="3cm")
```

```{r ctotalpreescripcion}
costo_ordenes_ej[1:5,] %>%
  select("formulacion", "compuesto_activo", "c_total") %>% 
  mutate(c_total=currency(c_total,"$",digits=2)) %>% 
  kbl(col.names = c("Formulación","Compuesto Activo", "Costo Total"),
      align = "clr",
      caption = "Costo total por preescripcion", label ="tabctotalpreesc") 
# %>%
  # kable_styling(latex_options = c("scale_down")) %>% 
  # column_spec(1:3, width="3cm")
```



```{r costounitariotableta}
costo_promedio <- costo_ordenes_ej %>%
  summarise(costo_tableta=sum(c_total)/sum(tabletas))

costo_promedio <- round(costo_promedio[[1]], 2)

ord_print <- costo_ordenes_ej %>%
  group_by(formulacion, compuesto_activo) %>%
  summarise(costo_tableta=round(sum(c_total)/sum(tabletas), 2), 
            .groups="keep") %>% 
  as.data.frame() 

ord_print %>%
  mutate(costo_tableta=currency(costo_tableta, "$", digits=2)) %>% 
  kbl(col.names = c("Formulación","Compuesto Activo", 
                    "Costo Promedio"),
      align = "clc",
      caption = "Costo de Tableta Promedio por Formulación", 
      label = "tabcostopromedioformula") %>% 
  column_spec(1:3, width="3cm")
```


## Costo de inversión

```{r inversioninstrumentos}

instrumentos <- read_csv("datos/instrumentos.csv", show_col_types = FALSE)
instrumentos[1:3] %>% 
  mutate(Precio=currency(Precio, symbol = "$", digits = 0L)) %>%
  kbl(col.names = c("Instrumento","Cantidad", 
                    "Precio"),
      align = "lcr",
      caption = "Equipo de Producción de Tabletas", 
      label = "tabequipoproduccion")
```

```{r inversiontotal}
inversion_total <- instrumentos %>%
  mutate(costo=Precio*Cantidad) %>%
  select(costo) %>%
  sum()

inversion <- c(inversion_total, rep(0,10))

inv_total_print <- currency(inversion_total, "$", 0)
```

La inversión total estimada para el caso base es de `r inv_total_print`.

## Depreciación

```{r depbase}
depreciacion <- tibble(
  periodo=0:10,
  depr=c(0, MACRS(investment = inversion_total, 
                     recovery_period = 5, n.period = 10))
)

depreciacion %>% 
  mutate(depr=currency(depr, "$", 0)) %>%
    kbl(col.names = c("Periodo","Depreciación"),
      align = "cr",
      caption = "Perfil de Depreciación MACRS a 5 años", 
      label = "tabperfildepreciacion")
```


## Resultados Caso base

```{r casobase}

expectativa_anual <- 150000 #[tabletas/periodo]
markup <- 0.3

costos_anuales <- c(0, rep(expectativa_anual*costo_promedio, 10))
ingresos_anuales <- costos_anuales * (1 + markup)

capital_trabajo_inicial <- info_compuestos %>%
  mutate(capital_trabajo=Precio_mxn_g*10*1000) %>%
  select(capital_trabajo) %>% sum()

cambio_CTN <- c(capital_trabajo_inicial, rep(0,10))

caso_base <- tibble(periodo=0:10,
      ingresos=ingresos_anuales, 
      costos=costos_anuales, 
      inversion=inversion, 
      depreciacion=depreciacion$depr, 
      cambio_CTN=cambio_CTN) 

caso_base%>%
  mutate(across(-1, ~currency(.x, symbol="$", digits=0))) %>%
  kbl(col.names = c("Periodo","Ingresos",
                    "Costos", "Inversión", 
                    "Depreciación", "Cambio de CTN"),
      align = "crrrrr",
      caption = "Flujos de Efectivo Caso Base", 
      label = "tabflujoscasobase")

```

```{r fcfcasobase}

tasa_gravable <- 0.3
tasa_descuento <- 0.09

fcf_caso_base <- caso_base %>%
  mutate(fcf=fcf(revenues=ingresos, 
                costs=costos, 
                depreciation=depreciacion, 
                capital_expenditures=inversion, 
                change_net_working_capital=cambio_CTN,
                tax_rate=tasa_gravable)) %>%
  unnest(fcf) %>%
  select(periodo, fcf)

fcf_caso_base %>%
  mutate(fcf=currency(fcf, "$", 0)) %>%
  kbl(col.names = c("Periodo","Flujo Libre"),
      align = "cr",
      caption = "Flujos de Efectivo Libre - Caso Base", 
      label = "tabflujolibrecasobase")
```

```{r npvcasobase}
npv_caso_base <- npv(rate=tasa_descuento, cashflow=fcf_caso_base$fcf, 
                     period=fcf_caso_base$periodo)
npv_caso_base_imp <- currency(npv_caso_base, "$", 0)
```

Con lo cual obtenemos un Valor Presente Neto de `r npv_caso_base_imp`.

## Valor Monetario Esperado

Para esta parte suponemos que no podemos realizar este proceso de producción 
indefinidamente desde la cochera de nuestros padres, por lo cual tenemos que
preguntar si vale más la pena rentar o comprar un almacén. Al igual, tenemos que 
considerar que los equipos que utilizamos necesitan mantenimiento para seguir 
operando adecuadamente.


```{r vmedatosentrada}
escenarios_costo <- round(costo_promedio * c(0.85, 1, 1.5), 2)
escenarios_tabletas <- expectativa_anual * c(0.7, 1, 1.2)
escenarios_markup <- markup * c(0.80, 1, 1.5)
escenarios_mantenimiento <- c(0.04, 0.05, 0.10)

precio_compra <- 1000000
renta_anual <- 120000
# tasa_descuento se mantiene
# inversion_total se mantiene

compra_flujo <- c(precio_compra, rep(0, 10))
renta_flujo <- c(0, rep(renta_anual,10))
inversion_flujo <- c(inversion_sin_compra, rep(0,10))


```


```{r arboldecision, fig.cap="Árbol de Decisión Tabletas Personalizables"}

escenarios <- c("B", "M", "A")
probabilidad <- c(0.15, 0.7, 0.15)
opciones_comprar <- c("CO", "RE")
comprar <- Node$new("¿Comprar?", type="decision")

# Agregar compra / renta
for (a in 1:2) {
  comprarenta <- comprar$AddChild(opciones_comprar[a], type="chance")
  # Agregar costo
  for (i in 1:3) {
  
    costo <- comprarenta$AddChild(paste(
      # opciones_comprar[a], "_",
                                        "C",escenarios[i], sep=""), 
                                  type="chance")
    costo$prob <- probabilidad[i]
  
    # Agregar tabletas
    for (j in 1:3) {
      
      tabletas <- costo$AddChild(paste(
        # opciones_comprar[a], "_",
        #                                "C",escenarios[i], "_",
                                       "T",escenarios[j], sep=""), 
                                 type="chance")
      tabletas$prob <- probabilidad[j]
      # Agregar Markup
      for (k in 1:3) {
        markup_es <- tabletas$AddChild(paste(
          # opciones_comprar[a], "_",
          #                                    "C",escenarios[i], "_",
          #                                    "T",escenarios[j], "_",
                                             "U",escenarios[k],sep=""), 
                                       type="chance")
        markup_es$prob <- probabilidad[k]
        # Agregar Mantenimiento
        for (l in 1:3) {
          mantenimiento <- markup_es$AddChild(
            paste(
              # opciones_comprar[a], "_",
              #     "C",escenarios[i],"_",
              #     "T",escenarios[j],"_",
              #     "U",escenarios[k],"_",
                  "M",escenarios[l],sep=""),
            type="terminal")
          mantenimiento$prob <- probabilidad[k]
          
          costo_anual_emv <- c(0, 
                               rep(escenarios_costo[i]*escenarios_tabletas[j],
                                   10))
          ingr_anual_emv <- costo_anual_emv*(1 + escenarios_markup[k])
          depreciacion_anual_emv <- c(0, MACRS(investment = inversion_total,
                                               recovery_period = 5,
                                               n.period=10))
          
          if (a == 1) {
            
            inversion_anual_emv <- inversion_flujo + compra_flujo
            
          } else {
            inversion_anual_emv <- inversion_flujo
            costo_anual_emv <- costo_anual_emv + renta_flujo
          }
          
          
          fcl <- fcf(revenues=ingr_anual_emv,
                     costs=costo_anual_emv,
                     depreciation=depreciacion_anual_emv,
                     capital_expenditures=inversion_anual_emv,
                     change_net_working_capital=cambio_CTN,
                     tax_rate=tasa_gravable)
          
          mantenimiento$npv <- npv(tasa_descuento, fcl, 0:11)
        }
      }
      
    }
  }
}

SetGraphStyle(comprar, rankdir = "TB")
SetNodeStyle(comprar, style = "filled,rounded", 
             label = AdjustNodeName, shape = "box")

plot(comprar)
```


```{r ejemplotabletasmedio, fig.cap="Árbol de Decisión a partir de un nodo de tabletas"}
t <- comprar$CO$CM$TM

plot(t)
```


```{r emvcalculo}

comprar$Do(function(node) node$npv <- w_npv(node), 
           filterFun = isNotLeaf, traversal = "post-order")

comprar_df <- ToDataFrameTypeCol(comprar, "prob", "npv")

comprar_df$npv <- currency(comprar_df$npv, symbol = "$", digits = 0L)
comprar_df$prob <- percent(comprar_df$prob, digits = 0)

comprar_df %>% 
  filter(npv >= 0) %>%
  arrange(desc(npv)) %>%
  select(c(2:6,8)) %>% 
  mutate_at(c(2:5), ~str_replace_all(., c("[CTUM]{1}A{1}"="Alto",
                                              "[CTUM]{1}M{1}"="Medio",
                                              "[CTUM]{1}B{1}"="Bajo"))) %>%
  mutate_at(1, ~str_replace_all(.,c("RE"="Rentar",
                                    "CO"="Comprar"))) %>% 
  kbl(longtable=T, booktabs=T, 
      col.names = c("Decisión", "Costo", "Volumen", "Markup", 
                    "Mantenimiento", "EMV"),
      align = "lllllr",
      caption = "VME Positivo - Tabletas Personalizables", 
      label = "tabemvtabletasarbol") %>% 
  kable_styling(latex_options = c("repeat_header")) %>% 
  column_spec(1:6, width="2cm")

```

\newpage
## Análisis de Sensibilidad


\newpage
## Simulación Monte Carlo
